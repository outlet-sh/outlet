import"../chunks/DsnmJJEf.js";import{a as pt,o as ft}from"../chunks/Hdby3CWe.js";import{f as x,p as mt,s as c,a as _t,u as xt,b as t,d as ht,e as bt,i as e,j as Ve,h as a,g as gt,c as o,r as s,t as q,n as k}from"../chunks/odI--4Kw.js";import{d as yt,s as M}from"../chunks/BNMK9zrr.js";import{l as kt,s as $t,i as g}from"../chunks/COaB7F5h.js";import{r as wt,e as St,i as Bt}from"../chunks/BohEjZuL.js";import{c as Ye,a as l,f as u,t as oe}from"../chunks/CCInJaqd.js";import{h as Ct}from"../chunks/hUjpWz_l.js";import{a as At,s as Pt,g as Et,A as Dt,C as Pe,B as le,k as Rt,l as Xe,I as Q,f as Tt,b as Mt}from"../chunks/DDAcQctE.js";import{a6 as jt,a7 as Ot,a8 as Lt,a9 as Ft,aa as Kt}from"../chunks/CbJUEE85.js";import{b as Ut}from"../chunks/CuiFJ7Vr.js";import{L as zt}from"../chunks/D716f0vp.js";import{S as Nt}from"../chunks/Ja6xzuDc.js";import{B as xe}from"../chunks/BD7k7D4N.js";import{g as It}from"../chunks/JX0wR62j.js";import{a as Yt}from"../chunks/ButTEuLv.js";import{P as Gt}from"../chunks/iPsqwY4C.js";import{R as Ht}from"../chunks/CqkV1_7K.js";import{T as Wt}from"../chunks/BzbtGsEE.js";import{C as qt}from"../chunks/CQeMb5RY.js";import"../chunks/B9hjHVe6.js";import{D as Qt}from"../chunks/DRk3_cHh.js";import{E as Vt}from"../chunks/x4ajjzDz.js";import{P as Xt}from"../chunks/DKWuo6o0.js";function Jt(Ee,he){const de=kt(he,["children","$$slots","$$events","$$legacy"]);const ne=[["line",{x1:"22",x2:"2",y1:"12",y2:"12"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16"}]];At(Ee,$t({name:"hard-drive"},()=>de,{get iconNode(){return ne},children:(j,B)=>{var K=Ye(),ie=x(K);Pt(ie,he,"default",{}),l(j,K)},$$slots:{default:!0}}))}var Zt=u("<p> </p>"),ea=u('<div class="mb-6"><!></div>'),ta=u('<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="checkbox checkbox-primary"/> <span class="text-sm text-text">Also upload to S3</span></label>'),aa=u("<!> ",1),ra=u('<div class="flex items-center justify-between mb-4"><h2 class="text-lg font-medium text-text">Create Backup</h2></div> <div class="space-y-4"><p class="text-sm text-text-muted">Creates a compressed backup containing both SQLite binary (.db) and SQL dump (.sql) formats.</p> <!> <!></div>',1),sa=u('<p class="text-sm text-text-muted text-center py-8">No backups yet. Create your first backup above.</p>'),oa=u('<!> <span class="ml-1">S3</span>',1),la=u('<!> <span class="ml-1">Local</span>',1),da=u('<tr class="border-b border-border hover:bg-bg-secondary"><td class="py-2 px-3 text-sm font-mono"> </td><td class="py-2 px-3 text-sm"> </td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm text-text-muted"> </td><td class="py-2 px-3 text-right"><div class="flex items-center justify-end gap-1"><!> <!></div></td></tr>'),na=u('<div class="overflow-x-auto"><table class="w-full"><thead><tr class="border-b border-border"><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Filename</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Size</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Type</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Storage</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Status</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Created</th><th class="text-right py-2 px-3 text-sm font-medium text-text-muted">Actions</th></tr></thead><tbody></tbody></table></div>'),ia=u('<div class="flex items-center justify-between mb-4"><h2 class="text-lg font-medium text-text">Backup History</h2> <!></div> <!>',1),ca=u("<!> Change",1),ua=u('<div class="flex items-center justify-between p-4 bg-surface-secondary rounded-lg border border-border"><div class="flex items-center gap-3"><!> <div><p class="font-medium text-text">AWS Credentials Configured</p> <p class="text-sm text-text-muted">Access Key ID: <code class="bg-surface-tertiary px-1.5 py-0.5 rounded text-xs">••••••••</code></p> <p class="text-sm text-text-muted">Secret Access Key: <code class="bg-surface-tertiary px-1.5 py-0.5 rounded text-xs">••••••••</code></p></div></div> <!></div>'),va=u("<div><!></div>"),pa=u('<div class="grid grid-cols-2 gap-4"><div><label for="s3-access-key" class="form-label">Access Key ID</label> <!></div> <div><label for="s3-secret-key" class="form-label">Secret Access Key</label> <!></div></div> <!>',1),fa=u('<div class="grid grid-cols-2 gap-4"><div><label for="s3-bucket" class="form-label">S3 Bucket</label> <!></div> <div><label for="s3-region" class="form-label">S3 Region</label> <!></div></div> <div><label for="s3-prefix" class="form-label">S3 Key Prefix (optional)</label> <!></div> <!> <div class="mt-6 pt-4 border-t border-border"><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-2"><h3 class="font-medium text-sm text-text">Required IAM Policy</h3> <a href="https://console.aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer" class="text-xs text-primary hover:underline flex items-center gap-1">Open IAM Console <!></a></div> <button type="button" class="text-xs text-primary hover:underline flex items-center gap-1"><!> </button></div> <p class="text-xs text-text-muted mb-2">Create an IAM user with this policy. Replace <code class="bg-base-200 px-1 rounded">YOUR-BUCKET-NAME</code> with your bucket name.</p> <pre class="text-xs bg-base-200 p-3 rounded-lg overflow-x-auto text-text-muted"></pre></div>',1),ma=u('<h2 class="text-lg font-medium text-text mb-4">S3 Storage Settings</h2> <div class="space-y-4"><!> <!></div>',1),_a=u('<p class="text-sm text-text-muted"> </p>'),xa=u('<div class="grid grid-cols-2 gap-4"><div><label for="schedule-cron" class="form-label">Schedule (Cron)</label> <!> <p class="mt-1 text-xs text-text-muted">Default: 3 AM daily (0 3 * * *)</p></div> <div><label for="retention-days" class="form-label">Retention (days)</label> <!> <p class="mt-1 text-xs text-text-muted">Backups older than this will be deleted</p></div></div> <!>',1),ha=u('<h2 class="text-lg font-medium text-text mb-4">Scheduled Backups</h2> <div class="space-y-4"><!> <!></div>',1),ba=u('<div class="space-y-6"><!> <!> <!> <!> <div class="flex justify-end"><!></div></div>'),ga=u("<!> <!> <!>",1);function Ga(Ee,he){mt(he,!0);let de=c(!0),ne=c(_t([])),j=c(null),B=c(""),K=c(!1),ie=c(!1),De=c(!1),be=c(!1),V=c(!1),ge=c(""),ye=c(""),Re=c(""),Te=c(""),ke=c(""),ce=c(!1),$e=c("0 3 * * *"),we=c(30),ue=c(!1),X=c(null),Me=c(!1),Se=c(!1),je=c(!1);const Je=`{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::YOUR-BUCKET-NAME",
        "arn:aws:s3:::YOUR-BUCKET-NAME/*"
      ]
    }
  ]
}`;async function Ze(){await navigator.clipboard.writeText(Je),t(je,!0),setTimeout(()=>t(je,!1),2e3)}let Oe=null;pt(()=>{const r=It();r.connect(Yt.user?.id),Oe=r.on("backup_update",d=>{console.log("[Backup] Received backup update:",d),ve()})}),ft(()=>{Oe&&Oe()}),xt(()=>{ve()});async function ve(){t(de,!0),t(B,"");try{const[r,d]=await Promise.all([jt({page:1,page_size:50}),Ot()]);t(ne,r.backups||[],!0),t(j,d,!0),t(V,d.s3_enabled,!0),t(ge,d.s3_bucket||"",!0),t(ye,d.s3_region||"",!0),t(ke,d.s3_prefix||"",!0),t(ce,d.schedule_enabled,!0),t($e,d.schedule_cron||"0 3 * * *",!0),t(we,d.retention_days||30,!0)}catch(r){console.error("Failed to load backup data:",r),t(B,r.message||"Failed to load backup data",!0)}finally{t(de,!1)}}async function et(){t(K,!0),t(B,"");try{await Ft({upload_to_s3:e(ie)&&e(V)}),await ve()}catch(r){console.error("Failed to create backup:",r),t(B,r.message||"Failed to create backup",!0)}finally{t(K,!1)}}async function tt(){t(De,!0),t(be,!1),t(B,"");try{const r=await Kt({s3_enabled:e(V),s3_bucket:e(ge),s3_region:e(ye),s3_access_key:e(Re),s3_secret_key:e(Te),s3_prefix:e(ke),schedule_enabled:e(ce),schedule_cron:e($e),retention_days:e(we)});t(j,r,!0),t(be,!0),setTimeout(()=>{t(be,!1)},2e3)}catch(r){console.error("Failed to save settings:",r),t(B,r.message||"Failed to save settings",!0)}finally{t(De,!1)}}function at(r){t(X,r,!0),t(ue,!0)}async function rt(){if(e(X)){t(Me,!0);try{await Lt({},e(X).id),t(ue,!1),t(X,null),await ve()}catch(r){console.error("Failed to delete backup:",r),t(B,r.message||"Failed to delete backup",!0)}finally{t(Me,!1)}}}async function st(r){try{const d=Ut();if(!d)throw new Error("Not authenticated");const y=await fetch(`/api/admin/backup/${r.id}/download`,{method:"GET",headers:{Authorization:`Bearer ${d}`}});if(!y.ok){const Z=await y.json().catch(()=>null);throw new Error(Z?.error||`Download failed: ${y.status}`)}const E=await y.blob(),J=window.URL.createObjectURL(E),$=document.createElement("a");$.href=J,$.download=r.filename,document.body.appendChild($),$.click(),window.URL.revokeObjectURL(J),document.body.removeChild($)}catch(d){console.error("Download failed:",d),t(B,d.message||"Failed to download backup",!0)}}function ot(r){if(r===0)return"0 B";const d=1024,y=["B","KB","MB","GB"],E=Math.floor(Math.log(r)/Math.log(d));return parseFloat((r/Math.pow(d,E)).toFixed(2))+" "+y[E]}function Ge(r){return r?new Date(r).toLocaleString():"-"}var He=ga();Ct("114nnst",r=>{bt(()=>{gt.title="Backup - Settings"})});var We=x(He);{var lt=r=>{var d=ea(),y=o(d);Dt(y,{type:"error",title:"Error",children:(E,J)=>{var $=Zt(),Z=o($,!0);s($),q(()=>M(Z,e(B))),l(E,$)},$$slots:{default:!0}}),s(d),l(r,d)};g(We,r=>{e(B)&&r(lt)})}var qe=a(We,2);{var dt=r=>{zt(r,{size:"large"})},nt=r=>{var d=ba(),y=o(d);Pe(y,{children:(U,Le)=>{var C=ra(),w=a(x(C),2),A=a(o(w),2);{var z=p=>{var f=ta(),v=o(f);wt(v),k(2),s(f),Rt(v,()=>e(ie),_=>t(ie,_)),l(p,f)};g(A,p=>{e(j)?.s3_enabled&&p(z)})}var N=a(A,2);le(N,{type:"primary",onclick:et,get disabled(){return e(K)},children:(p,f)=>{var v=aa(),_=x(v);Gt(_,{class:"mr-2 h-4 w-4"});var O=a(_);q(()=>M(O,` ${e(K)?"Creating Backup...":"Create Backup Now"}`)),l(p,v)},$$slots:{default:!0}}),s(w),l(U,C)},$$slots:{default:!0}});var E=a(y,2);Pe(E,{children:(U,Le)=>{var C=ia(),w=x(C),A=a(o(w),2);le(A,{type:"ghost",onclick:ve,children:(f,v)=>{Ht(f,{class:"h-4 w-4"})},$$slots:{default:!0}}),s(w);var z=a(w,2);{var N=f=>{var v=sa();l(f,v)},p=f=>{var v=na(),_=o(v),O=a(o(_));St(O,21,()=>e(ne),Bt,(I,m)=>{var D=da(),Y=o(D),S=o(Y,!0);s(Y);var R=a(Y),pe=o(R,!0);s(R);var L=a(R),fe=o(L);xe(fe,{type:"secondary",children:(n,i)=>{k();var b=oe();q(()=>M(b,e(m).backup_type)),l(n,b)},$$slots:{default:!0}}),s(L);var G=a(L),Be=o(G);{var Fe=n=>{var i=oa(),b=x(i);qt(b,{class:"h-4 w-4 inline text-primary"}),k(2),l(n,i)},me=n=>{var i=la(),b=x(i);Jt(b,{class:"h-4 w-4 inline text-text-muted"}),k(2),l(n,i)};g(Be,n=>{e(m).storage_type==="s3"?n(Fe):n(me,!1)})}s(G);var ee=a(G),Ke=o(ee);{var Ue=n=>{xe(n,{type:"success",children:(i,b)=>{k();var _e=oe("Completed");l(i,_e)},$$slots:{default:!0}})},h=n=>{var i=Ye(),b=x(i);{var _e=W=>{xe(W,{type:"warning",children:(re,Qe)=>{k();var Ne=oe("Working");l(re,Ne)},$$slots:{default:!0}})},ze=W=>{var re=Ye(),Qe=x(re);{var Ne=se=>{xe(se,{type:"error",children:(Ie,vt)=>{k();var Ae=oe("Failed");l(Ie,Ae)},$$slots:{default:!0}})},ut=se=>{xe(se,{type:"secondary",children:(Ie,vt)=>{k();var Ae=oe();q(()=>M(Ae,e(m).status)),l(Ie,Ae)},$$slots:{default:!0}})};g(Qe,se=>{e(m).status==="failed"?se(Ne):se(ut,!1)},!0)}l(W,re)};g(b,W=>{e(m).status==="in_progress"?W(_e):W(ze,!1)},!0)}l(n,i)};g(Ke,n=>{e(m).status==="completed"?n(Ue):n(h,!1)})}s(ee);var P=a(ee),T=o(P,!0);s(P);var F=a(P),te=o(F),H=o(te);{var Ce=n=>{le(n,{type:"ghost",size:"icon",onclick:()=>st(e(m)),children:(i,b)=>{Qt(i,{class:"h-4 w-4"})},$$slots:{default:!0}})};g(H,n=>{e(m).status==="completed"&&n(Ce)})}var ae=a(H,2);le(ae,{type:"ghost",size:"icon",onclick:()=>at(e(m)),children:(n,i)=>{Wt(n,{class:"h-4 w-4 text-red-500"})},$$slots:{default:!0}}),s(te),s(F),s(D),q((n,i)=>{M(S,e(m).filename),M(pe,n),M(T,i)},[()=>ot(e(m).file_size),()=>Ge(e(m).started_at)]),l(I,D)}),s(O),s(_),s(v),l(f,v)};g(z,f=>{e(ne).length===0?f(N):f(p,!1)})}l(U,C)},$$slots:{default:!0}});var J=a(E,2);Pe(J,{children:(U,Le)=>{var C=ma(),w=a(x(C),2),A=o(w);Xe(A,{label:"Enable S3 backup storage",get checked(){return e(V)},set checked(p){t(V,p,!0)}});var z=a(A,2);{var N=p=>{var f=fa(),v=x(f),_=o(v),O=a(o(_),2);Q(O,{id:"s3-bucket",type:"text",placeholder:"my-backup-bucket",get value(){return e(ge)},set value(h){t(ge,h,!0)}}),s(_);var I=a(_,2),m=a(o(I),2);Q(m,{id:"s3-region",type:"text",placeholder:"us-east-1",get value(){return e(ye)},set value(h){t(ye,h,!0)}}),s(I),s(v);var D=a(v,2),Y=a(o(D),2);Q(Y,{id:"s3-prefix",type:"text",placeholder:"backups/outlet/",get value(){return e(ke)},set value(h){t(ke,h,!0)}}),s(D);var S=a(D,2);{var R=h=>{var P=ua(),T=o(P),F=o(T);Mt(F,{class:"h-5 w-5 text-green-500"}),k(2),s(T);var te=a(T,2);le(te,{type:"secondary",size:"sm",onclick:()=>t(Se,!0),children:(H,Ce)=>{var ae=ca(),n=x(ae);Xt(n,{class:"h-4 w-4 mr-1.5"}),k(),l(H,ae)},$$slots:{default:!0}}),s(P),l(h,P)},pe=h=>{var P=pa(),T=x(P),F=o(T),te=a(o(F),2);Q(te,{id:"s3-access-key",type:"text",placeholder:"AKIAIOSFODNN7EXAMPLE",get value(){return e(Re)},set value(i){t(Re,i,!0)}}),s(F);var H=a(F,2),Ce=a(o(H),2);Q(Ce,{id:"s3-secret-key",type:"password",placeholder:"",get value(){return e(Te)},set value(i){t(Te,i,!0)}}),s(H),s(T);var ae=a(T,2);{var n=i=>{var b=va(),_e=o(b);le(_e,{type:"secondary",size:"sm",onclick:()=>t(Se,!1),children:(ze,W)=>{k();var re=oe("Cancel");l(ze,re)},$$slots:{default:!0}}),s(b),l(i,b)};g(ae,i=>{e(Se)&&i(n)})}l(h,P)};g(S,h=>{e(j)?.has_s3_creds&&!e(Se)?h(R):h(pe,!1)})}var L=a(S,2),fe=o(L),G=o(fe),Be=a(o(G),2),Fe=a(o(Be));Vt(Fe,{class:"w-3 h-3"}),s(Be),s(G);var me=a(G,2);me.__click=Ze;var ee=o(me);Tt(ee,{class:"w-3 h-3"});var Ke=a(ee);s(me),s(fe);var Ue=a(fe,4);Ue.textContent=`{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::YOUR-BUCKET-NAME",
        "arn:aws:s3:::YOUR-BUCKET-NAME/*"
      ]
    }
  ]
}`,s(L),q(()=>M(Ke,` ${e(je)?"Copied!":"Copy"}`)),l(p,f)};g(z,p=>{e(V)&&p(N)})}s(w),l(U,C)},$$slots:{default:!0}});var $=a(J,2);Pe($,{children:(U,Le)=>{var C=ha(),w=a(x(C),2),A=o(w);Xe(A,{label:"Enable scheduled backups",get checked(){return e(ce)},set checked(p){t(ce,p,!0)}});var z=a(A,2);{var N=p=>{var f=xa(),v=x(f),_=o(v),O=a(o(_),2);Q(O,{id:"schedule-cron",type:"text",placeholder:"0 3 * * *",get value(){return e($e)},set value(S){t($e,S,!0)}}),k(2),s(_);var I=a(_,2),m=a(o(I),2);Q(m,{id:"retention-days",type:"number",min:"1",max:"365",get value(){return e(we)},set value(S){t(we,S,!0)}}),k(2),s(I),s(v);var D=a(v,2);{var Y=S=>{var R=_a(),pe=o(R);s(R),q(L=>M(pe,`Last backup: ${L??""}`),[()=>Ge(e(j).last_backup_at)]),l(S,R)};g(D,S=>{e(j)?.last_backup_at&&S(Y)})}l(p,f)};g(z,p=>{e(ce)&&p(N)})}s(w),l(U,C)},$$slots:{default:!0}});var Z=a($,2),ct=o(Z);Nt(ct,{label:"Save Settings",get saving(){return e(De)},get saved(){return e(be)},onclick:tt}),s(Z),s(d),l(r,d)};g(qe,r=>{e(de)?r(dt):r(nt,!1)})}var it=a(qe,2);{let r=Ve(()=>`Are you sure you want to delete "${e(X)?.filename}"? This action cannot be undone.`),d=Ve(()=>e(Me)?"Deleting...":"Delete");Et(it,{title:"Delete Backup",get description(){return e(r)},get actionLabel(){return e(d)},actionType:"danger",onAction:rt,onCancel:()=>{t(ue,!1),t(X,null)},get open(){return e(ue)},set open(y){t(ue,y,!0)}})}l(Ee,He),ht()}yt(["click"]);export{Ga as component};
