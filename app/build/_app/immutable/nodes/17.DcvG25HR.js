import"../chunks/DsnmJJEf.js";import{a as vt,o as pt}from"../chunks/Hdby3CWe.js";import{f as b,p as ft,s as i,a as mt,u as _t,b as t,d as xt,e as ht,g as bt,i as e,h as r,j as $e,c as o,r as s,t as N,n as A}from"../chunks/odI--4Kw.js";import{d as gt,s as T}from"../chunks/BNMK9zrr.js";import{l as yt,s as kt,i as k}from"../chunks/COaB7F5h.js";import{r as $t,e as wt,i as St}from"../chunks/BohEjZuL.js";import{c as Fe,a as n,f as p,t as ce}from"../chunks/CCInJaqd.js";import{h as Bt}from"../chunks/hUjpWz_l.js";import{a as Ct,s as Pt,h as At,A as Et,C as we,B as Se,l as Dt,m as qe,I,f as Rt}from"../chunks/Bx02zSD-.js";import{a4 as Tt,a5 as Mt,a6 as jt,a7 as Lt,a8 as Ot}from"../chunks/cAHYBDdg.js";import{b as Ut}from"../chunks/CuiFJ7Vr.js";import{L as Ft}from"../chunks/D716f0vp.js";import{S as zt}from"../chunks/DOWBBqXL.js";import{B as ue}from"../chunks/BD7k7D4N.js";import{g as Kt}from"../chunks/B2niTBGE.js";import{P as Nt}from"../chunks/DaHdHLtU.js";import{R as It}from"../chunks/bFCXf7rz.js";import{T as Yt}from"../chunks/CwD6Wilq.js";import{C as Gt}from"../chunks/CNkcpZ44.js";import"../chunks/B9hjHVe6.js";import{D as Ht}from"../chunks/BNZnddFw.js";import{E as qt}from"../chunks/jEkFUqdF.js";function Qt(Be,ve){const X=yt(ve,["children","$$slots","$$events","$$legacy"]);const Z=[["line",{x1:"22",x2:"2",y1:"12",y2:"12"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16"}]];Ct(Be,kt({name:"hard-drive"},()=>X,{get iconNode(){return Z},children:(E,$)=>{var L=Fe(),ee=b(L);Pt(ee,ve,"default",{}),n(E,L)},$$slots:{default:!0}}))}var Vt=p("<p> </p>"),Wt=p('<div class="mb-6"><!></div>'),Jt=p('<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="checkbox checkbox-primary"/> <span class="text-sm text-text">Also upload to S3</span></label>'),Xt=p("<!> ",1),Zt=p('<div class="flex items-center justify-between mb-4"><h2 class="text-lg font-medium text-text">Create Backup</h2></div> <div class="space-y-4"><p class="text-sm text-text-muted">Creates a compressed backup containing both SQLite binary (.db) and SQL dump (.sql) formats.</p> <!> <!></div>',1),ea=p('<p class="text-sm text-text-muted text-center py-8">No backups yet. Create your first backup above.</p>'),ta=p('<!> <span class="ml-1">S3</span>',1),aa=p('<!> <span class="ml-1">Local</span>',1),ra=p('<tr class="border-b border-border hover:bg-bg-secondary"><td class="py-2 px-3 text-sm font-mono"> </td><td class="py-2 px-3 text-sm"> </td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm"><!></td><td class="py-2 px-3 text-sm text-text-muted"> </td><td class="py-2 px-3 text-right"><div class="flex items-center justify-end gap-1"><!> <!></div></td></tr>'),sa=p('<div class="overflow-x-auto"><table class="w-full"><thead><tr class="border-b border-border"><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Filename</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Size</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Type</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Storage</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Status</th><th class="text-left py-2 px-3 text-sm font-medium text-text-muted">Created</th><th class="text-right py-2 px-3 text-sm font-medium text-text-muted">Actions</th></tr></thead><tbody></tbody></table></div>'),oa=p('<div class="flex items-center justify-between mb-4"><h2 class="text-lg font-medium text-text">Backup History</h2> <!></div> <!>',1),la=p('<div class="grid grid-cols-2 gap-4"><div><label for="s3-bucket" class="form-label">S3 Bucket</label> <!></div> <div><label for="s3-region" class="form-label">S3 Region</label> <!></div></div> <div><label for="s3-prefix" class="form-label">S3 Key Prefix (optional)</label> <!></div> <div class="grid grid-cols-2 gap-4"><div><label for="s3-access-key" class="form-label">Access Key ID</label> <!></div> <div><label for="s3-secret-key" class="form-label">Secret Access Key</label> <!></div></div> <div class="mt-6 pt-4 border-t border-border"><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-2"><h3 class="font-medium text-sm text-text">Required IAM Policy</h3> <a href="https://console.aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer" class="text-xs text-primary hover:underline flex items-center gap-1">Open IAM Console <!></a></div> <button type="button" class="text-xs text-primary hover:underline flex items-center gap-1"><!> </button></div> <p class="text-xs text-text-muted mb-2">Create an IAM user with this policy. Replace <code class="bg-base-200 px-1 rounded">YOUR-BUCKET-NAME</code> with your bucket name.</p> <pre class="text-xs bg-base-200 p-3 rounded-lg overflow-x-auto text-text-muted"></pre></div>',1),na=p('<h2 class="text-lg font-medium text-text mb-4">S3 Storage Settings</h2> <div class="space-y-4"><!> <!></div>',1),da=p('<p class="text-sm text-text-muted"> </p>'),ia=p('<div class="grid grid-cols-2 gap-4"><div><label for="schedule-cron" class="form-label">Schedule (Cron)</label> <!> <p class="mt-1 text-xs text-text-muted">Default: 3 AM daily (0 3 * * *)</p></div> <div><label for="retention-days" class="form-label">Retention (days)</label> <!> <p class="mt-1 text-xs text-text-muted">Backups older than this will be deleted</p></div></div> <!>',1),ca=p('<h2 class="text-lg font-medium text-text mb-4">Scheduled Backups</h2> <div class="space-y-4"><!> <!></div>',1),ua=p('<div class="space-y-6"><!> <!> <!> <!> <div class="flex justify-end"><!></div></div>'),va=p("<!> <!> <!>",1);function ja(Be,ve){ft(ve,!0);let X=i(!0),Z=i(mt([])),E=i(null),$=i(""),L=i(!1),ee=i(!1),Ce=i(!1),pe=i(!1),Y=i(!1),fe=i(""),me=i(""),Pe=i(""),Ae=i(""),_e=i(""),te=i(!1),xe=i("0 3 * * *"),he=i(30),ae=i(!1),G=i(null),Ee=i(!1),De=i(!1);const Qe=`{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::YOUR-BUCKET-NAME",
        "arn:aws:s3:::YOUR-BUCKET-NAME/*"
      ]
    }
  ]
}`;async function Ve(){await navigator.clipboard.writeText(Qe),t(De,!0),setTimeout(()=>t(De,!1),2e3)}let Re=null;vt(()=>{const a=Kt();a.connect(),Re=a.on("backup_update",l=>{console.log("[Backup] Received backup update:",l),re()})}),pt(()=>{Re&&Re()}),_t(()=>{re()});async function re(){t(X,!0),t($,"");try{const[a,l]=await Promise.all([Tt({page:1,page_size:50}),Mt()]);t(Z,a.backups||[],!0),t(E,l,!0),t(Y,l.s3_enabled,!0),t(fe,l.s3_bucket||"",!0),t(me,l.s3_region||"",!0),t(_e,l.s3_prefix||"",!0),t(te,l.schedule_enabled,!0),t(xe,l.schedule_cron||"0 3 * * *",!0),t(he,l.retention_days||30,!0)}catch(a){console.error("Failed to load backup data:",a),t($,a.message||"Failed to load backup data",!0)}finally{t(X,!1)}}async function We(){t(L,!0),t($,"");try{await Lt({upload_to_s3:e(ee)&&e(Y)}),await re()}catch(a){console.error("Failed to create backup:",a),t($,a.message||"Failed to create backup",!0)}finally{t(L,!1)}}async function Je(){t(Ce,!0),t(pe,!1),t($,"");try{const a=await Ot({s3_enabled:e(Y),s3_bucket:e(fe),s3_region:e(me),s3_access_key:e(Pe),s3_secret_key:e(Ae),s3_prefix:e(_e),schedule_enabled:e(te),schedule_cron:e(xe),retention_days:e(he)});t(E,a,!0),t(pe,!0),setTimeout(()=>{t(pe,!1)},2e3)}catch(a){console.error("Failed to save settings:",a),t($,a.message||"Failed to save settings",!0)}finally{t(Ce,!1)}}function Xe(a){t(G,a,!0),t(ae,!0)}async function Ze(){if(e(G)){t(Ee,!0);try{await jt({},e(G).id),t(ae,!1),t(G,null),await re()}catch(a){console.error("Failed to delete backup:",a),t($,a.message||"Failed to delete backup",!0)}finally{t(Ee,!1)}}}async function et(a){try{const l=Ut();if(!l)throw new Error("Not authenticated");const x=await fetch(`/api/admin/backup/${a.id}/download`,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!x.ok){const q=await x.json().catch(()=>null);throw new Error(q?.error||`Download failed: ${x.status}`)}const D=await x.blob(),H=window.URL.createObjectURL(D),g=document.createElement("a");g.href=H,g.download=a.filename,document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(H),document.body.removeChild(g)}catch(l){console.error("Download failed:",l),t($,l.message||"Failed to download backup",!0)}}function tt(a){if(a===0)return"0 B";const l=1024,x=["B","KB","MB","GB"],D=Math.floor(Math.log(a)/Math.log(l));return parseFloat((a/Math.pow(l,D)).toFixed(2))+" "+x[D]}function ze(a){return a?new Date(a).toLocaleString():"-"}var Ke=va();Bt("114nnst",a=>{ht(()=>{bt.title="Backup - Settings"})});var Ne=b(Ke);{var at=a=>{var l=Wt(),x=o(l);Et(x,{type:"error",title:"Error",children:(D,H)=>{var g=Vt(),q=o(g,!0);s(g),N(()=>T(q,e($))),n(D,g)},$$slots:{default:!0}}),s(l),n(a,l)};k(Ne,a=>{e($)&&a(at)})}var Ie=r(Ne,2);{var rt=a=>{Ft(a,{size:"large"})},st=a=>{var l=ua(),x=o(l);we(x,{children:(O,Te)=>{var w=Zt(),y=r(b(w),2),C=r(o(y),2);{var U=u=>{var v=Jt(),c=o(v);$t(c),A(2),s(v),Dt(c,()=>e(ee),_=>t(ee,_)),n(u,v)};k(C,u=>{e(E)?.s3_enabled&&u(U)})}var F=r(C,2);Se(F,{type:"primary",onclick:We,get disabled(){return e(L)},children:(u,v)=>{var c=Xt(),_=b(c);Nt(_,{class:"mr-2 h-4 w-4"});var M=r(_);N(()=>T(M,` ${e(L)?"Creating Backup...":"Create Backup Now"}`)),n(u,c)},$$slots:{default:!0}}),s(y),n(O,w)},$$slots:{default:!0}});var D=r(x,2);we(D,{children:(O,Te)=>{var w=oa(),y=b(w),C=r(o(y),2);Se(C,{type:"ghost",onclick:re,children:(v,c)=>{It(v,{class:"h-4 w-4"})},$$slots:{default:!0}}),s(y);var U=r(y,2);{var F=v=>{var c=ea();n(v,c)},u=v=>{var c=sa(),_=o(c),M=r(o(_));wt(M,21,()=>e(Z),St,(z,f)=>{var R=ra(),K=o(R),h=o(K,!0);s(K);var S=r(K),se=o(S,!0);s(S);var j=r(S),Me=o(j);ue(Me,{type:"secondary",children:(d,m)=>{A();var P=ce();N(()=>T(P,e(f).backup_type)),n(d,P)},$$slots:{default:!0}}),s(j);var Q=r(j),oe=o(Q);{var le=d=>{var m=ta(),P=b(m);Gt(P,{class:"h-4 w-4 inline text-primary"}),A(2),n(d,m)},be=d=>{var m=aa(),P=b(m);Qt(P,{class:"h-4 w-4 inline text-text-muted"}),A(2),n(d,m)};k(oe,d=>{e(f).storage_type==="s3"?d(le):d(be,!1)})}s(Q);var ne=r(Q),de=o(ne);{var ge=d=>{ue(d,{type:"success",children:(m,P)=>{A();var Le=ce("Completed");n(m,Le)},$$slots:{default:!0}})},je=d=>{var m=Fe(),P=b(m);{var Le=W=>{ue(W,{type:"warning",children:(ye,He)=>{A();var Oe=ce("Working");n(ye,Oe)},$$slots:{default:!0}})},it=W=>{var ye=Fe(),He=b(ye);{var Oe=J=>{ue(J,{type:"error",children:(Ue,ut)=>{A();var ke=ce("Failed");n(Ue,ke)},$$slots:{default:!0}})},ct=J=>{ue(J,{type:"secondary",children:(Ue,ut)=>{A();var ke=ce();N(()=>T(ke,e(f).status)),n(Ue,ke)},$$slots:{default:!0}})};k(He,J=>{e(f).status==="failed"?J(Oe):J(ct,!1)},!0)}n(W,ye)};k(P,W=>{e(f).status==="in_progress"?W(Le):W(it,!1)},!0)}n(d,m)};k(de,d=>{e(f).status==="completed"?d(ge):d(je,!1)})}s(ne);var ie=r(ne),B=o(ie,!0);s(ie);var V=r(ie),Ye=o(V),Ge=o(Ye);{var nt=d=>{Se(d,{type:"ghost",size:"icon",onclick:()=>et(e(f)),children:(m,P)=>{Ht(m,{class:"h-4 w-4"})},$$slots:{default:!0}})};k(Ge,d=>{e(f).status==="completed"&&d(nt)})}var dt=r(Ge,2);Se(dt,{type:"ghost",size:"icon",onclick:()=>Xe(e(f)),children:(d,m)=>{Yt(d,{class:"h-4 w-4 text-red-500"})},$$slots:{default:!0}}),s(Ye),s(V),s(R),N((d,m)=>{T(h,e(f).filename),T(se,d),T(B,m)},[()=>tt(e(f).file_size),()=>ze(e(f).started_at)]),n(z,R)}),s(M),s(_),s(c),n(v,c)};k(U,v=>{e(Z).length===0?v(F):v(u,!1)})}n(O,w)},$$slots:{default:!0}});var H=r(D,2);we(H,{children:(O,Te)=>{var w=na(),y=r(b(w),2),C=o(y);qe(C,{label:"Enable S3 backup storage",get checked(){return e(Y)},set checked(u){t(Y,u,!0)}});var U=r(C,2);{var F=u=>{var v=la(),c=b(v),_=o(c),M=r(o(_),2);I(M,{id:"s3-bucket",type:"text",placeholder:"my-backup-bucket",get value(){return e(fe)},set value(B){t(fe,B,!0)}}),s(_);var z=r(_,2),f=r(o(z),2);I(f,{id:"s3-region",type:"text",placeholder:"us-east-1",get value(){return e(me)},set value(B){t(me,B,!0)}}),s(z),s(c);var R=r(c,2),K=r(o(R),2);I(K,{id:"s3-prefix",type:"text",placeholder:"backups/outlet/",get value(){return e(_e)},set value(B){t(_e,B,!0)}}),s(R);var h=r(R,2),S=o(h),se=r(o(S),2);{let B=$e(()=>e(E)?.has_s3_creds?"••••••••":"Enter access key");I(se,{id:"s3-access-key",type:"password",get placeholder(){return e(B)},get value(){return e(Pe)},set value(V){t(Pe,V,!0)}})}s(S);var j=r(S,2),Me=r(o(j),2);{let B=$e(()=>e(E)?.has_s3_creds?"••••••••":"Enter secret key");I(Me,{id:"s3-secret-key",type:"password",get placeholder(){return e(B)},get value(){return e(Ae)},set value(V){t(Ae,V,!0)}})}s(j),s(h);var Q=r(h,2),oe=o(Q),le=o(oe),be=r(o(le),2),ne=r(o(be));qt(ne,{class:"w-3 h-3"}),s(be),s(le);var de=r(le,2);de.__click=Ve;var ge=o(de);Rt(ge,{class:"w-3 h-3"});var je=r(ge);s(de),s(oe);var ie=r(oe,4);ie.textContent=`{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::YOUR-BUCKET-NAME",
        "arn:aws:s3:::YOUR-BUCKET-NAME/*"
      ]
    }
  ]
}`,s(Q),N(()=>T(je,` ${e(De)?"Copied!":"Copy"}`)),n(u,v)};k(U,u=>{e(Y)&&u(F)})}s(y),n(O,w)},$$slots:{default:!0}});var g=r(H,2);we(g,{children:(O,Te)=>{var w=ca(),y=r(b(w),2),C=o(y);qe(C,{label:"Enable scheduled backups",get checked(){return e(te)},set checked(u){t(te,u,!0)}});var U=r(C,2);{var F=u=>{var v=ia(),c=b(v),_=o(c),M=r(o(_),2);I(M,{id:"schedule-cron",type:"text",placeholder:"0 3 * * *",get value(){return e(xe)},set value(h){t(xe,h,!0)}}),A(2),s(_);var z=r(_,2),f=r(o(z),2);I(f,{id:"retention-days",type:"number",min:"1",max:"365",get value(){return e(he)},set value(h){t(he,h,!0)}}),A(2),s(z),s(c);var R=r(c,2);{var K=h=>{var S=da(),se=o(S);s(S),N(j=>T(se,`Last backup: ${j??""}`),[()=>ze(e(E).last_backup_at)]),n(h,S)};k(R,h=>{e(E)?.last_backup_at&&h(K)})}n(u,v)};k(U,u=>{e(te)&&u(F)})}s(y),n(O,w)},$$slots:{default:!0}});var q=r(g,2),lt=o(q);zt(lt,{label:"Save Settings",get saving(){return e(Ce)},get saved(){return e(pe)},onclick:Je}),s(q),s(l),n(a,l)};k(Ie,a=>{e(X)?a(rt):a(st,!1)})}var ot=r(Ie,2);{let a=$e(()=>`Are you sure you want to delete "${e(G)?.filename}"? This action cannot be undone.`),l=$e(()=>e(Ee)?"Deleting...":"Delete");At(ot,{title:"Delete Backup",get description(){return e(a)},get actionLabel(){return e(l)},actionType:"danger",onAction:Ze,onCancel:()=>{t(ae,!1),t(G,null)},get open(){return e(ae)},set open(x){t(ae,x,!0)}})}n(Be,Ke),xt()}gt(["click"]);export{ja as component};
