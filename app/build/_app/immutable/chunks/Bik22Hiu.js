import{a as u}from"./DcVA94f2.js";function S(){if(typeof window>"u")return"";const c=window.location.origin,e=c.startsWith("https:")?"wss:":"ws:",s=c.replace(/^https?:/,"");return`${e}${s}/ws`}class w{ws=null;listeners=new Map;statusListeners=new Set;messageQueue=[];currentStatus="disconnected";closedByUser=!1;reconnectTimeout=null;reconnectAttempts=0;clientId;userId;constructor(){this.clientId=this.generateClientId(),this.userId="anonymous"}generateClientId(){return`client_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}setStatus(e){this.currentStatus!==e&&(this.currentStatus=e,this.statusListeners.forEach(s=>s(e)))}connect(e){if(e?this.userId=e:u.user?.id&&(this.userId=u.user.id),this.ws?.readyState===WebSocket.OPEN||this.ws?.readyState===WebSocket.CONNECTING)return;this.closedByUser=!1,this.setStatus("connecting");const o=`${S()}?clientId=${this.clientId}&userId=${this.userId}`;console.log("[WebSocket] Connecting to:",o);try{this.ws=new WebSocket(o),this.ws.onopen=()=>{for(console.log("[WebSocket] Connection opened"),this.setStatus("connected"),this.reconnectAttempts=0,console.log("[WebSocket] Sending",this.messageQueue.length,"queued messages");this.messageQueue.length>0;){const t=this.messageQueue.shift();t&&this.ws?.readyState===WebSocket.OPEN&&(console.log("[WebSocket] Sending queued message"),this.ws.send(t))}},this.ws.onclose=t=>{if(console.log("[WebSocket] Connection closed:",t.code,t.reason),this.setStatus("disconnected"),this.ws=null,!this.closedByUser){const i=Math.min(2e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectTimeout=setTimeout(()=>{this.reconnectAttempts++,this.connect()},i)}},this.ws.onerror=t=>{console.error("[WebSocket] Error:",t),this.setStatus("error")},this.ws.onmessage=async t=>{const i=t.data;console.log("[WebSocket] Raw message received:",i.substring(0,200));const h=i.split(`
`).filter(r=>r.trim());for(const r of h)try{const n=JSON.parse(r);if(console.log("[WebSocket] Parsed message:",n.type,n.data),n.type==="ping"){this.send("pong",{timestamp:new Date().toISOString()});continue}if(n.type==="pong")continue;const a=this.listeners.get(n.type);if(console.log("[WebSocket] Handlers for",n.type,":",a?.size??0),a)for(const d of a)try{await d(n.data)}catch(g){console.error("Error in message handler:",g)}}catch(n){console.error("Failed to parse WebSocket message:",n,"Raw:",r)}}}catch(t){console.error("WebSocket connection error:",t),this.setStatus("error")}}disconnect(){this.closedByUser=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.ws&&(this.ws.close(),this.ws=null),this.setStatus("disconnected")}on(e,s){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s),()=>{const o=this.listeners.get(e);o&&(o.delete(s),o.size===0&&this.listeners.delete(e))}}onStatus(e){return this.statusListeners.add(e),e(this.currentStatus),()=>{this.statusListeners.delete(e)}}send(e,s){const o={type:e,data:s,timestamp:new Date().toISOString()},t=JSON.stringify(o);console.log("[WebSocket] Sending message:",e,"readyState:",this.ws?.readyState),this.ws?.readyState===WebSocket.OPEN?(this.ws.send(t),console.log("[WebSocket] Message sent successfully")):(console.log("[WebSocket] Queuing message, WS not open"),this.messageQueue.push(t))}requestRewrite(e){this.send("rewrite",e)}getStatus(){return this.currentStatus}isConnected(){return this.currentStatus==="connected"}}let l=null;function f(){return l||(l=new w),l}export{f as g};
